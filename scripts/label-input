#!/bin/bash

set -e
source functions.sh

make_mapping()
{
  pols=(x y)
  pol=$1

  if [ ! -f ${CORR_CONFIG}/wbc ] ; then
    kcs_error "unable to locate configuration wbc"
    return 1
  fi

  i=0
  declare -a roachposmap
  for name in $(grep ^servers_f.*roach ${CORR_CONFIG}/wbc | cut -f2 -d= | tr '[, ]' '\n' ) ; do
    roachposmap[$i]=$name
    i=$[i+1]
  done

  inp=$i

  : > ${MAIN_MAPPING}
  
  i=0
  while [ $i -lt $inp ] ; do
    j=0
    while [ $j -lt $pol ] ; do
      j=$[j+1]
      echo ${i}${pols[$j]}:${i}${pols[$j]}:${roachposmap[$i]} >> ${MAIN_MAPPING}
    done
    i=$[i+1]
  done

  return 0
}

if [ ! -s ${MAIN_MAPPING} ] ; then
  kcs_info "generating initial mapping"
  make_mapping 2
fi

if [ $# -lt 1 ] ; then

  if [ ! -s ${MAIN_MAPPING} ] ; then
    kcs_error "no correlator mapping found"
  fi

  cat ${MAIN_MAPPING} | tr -s : ' ' | sed -s 's/^/#label-input /'

  exit 0
fi

exit 0

############################################

index=$(kcs_input_to_index $1)
result=1

if [ -z "${index}" ] ; then
  kcs_error "unable to parse input label ${index}"
fi

if [ ${index} -ge 16 ] ; then
  kcs_error "input label ${index} unexpectedly large"
fi

index=$(kcs_input_to_index $1)

if [ $# -gt 1 ] ; then
  synonym=${2}
else
  synonym=${1}
fi

kcs_debug "setting label for $1  to ${synonym}"

if kcpcmd -k -r label-input ${index} ${synonym} ; then
  result=0
fi

kcs_corr_log

if [ "${result}" != "0" ] ; then
  exit 1
fi

echo "#return ok ${synonym}"
exit 0

